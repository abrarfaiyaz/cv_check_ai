<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resume Feature Extractor</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist/build/pdf.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      h1 {
        text-align: center;
      }
      #outputTable {
        margin-top: 20px;
        border-collapse: collapse;
        width: 100%;
      }
      #outputTable th,
      #outputTable td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      #outputTable th {
        background-color: #f2f2f2;
      }
      button {
        margin-top: 10px;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Resume Feature Extractor</h1>
    <p>Select a folder containing resumes in PDF format:</p>
    <input type="file" id="pdfUpload" webkitdirectory directory multiple />
    <button onclick="processResumes()">Process Resumes</button>
    <button onclick="downloadJson()">Download JSON</button>
    <button onclick="downloadCsv()">Download CSV</button>
    <table id="outputTable"></table>

    <script>
      //const apiKey = "YOUR_OPENAI_API_KEY"; // Replace with your OpenAI API key
      let extractedData = [];

      async function processResumes() {
        const input = document.getElementById("pdfUpload");
        const files = Array.from(input.files);
        const outputTable = document.getElementById("outputTable");

        if (files.length === 0) {
          alert("Please select a folder containing PDF files.");
          return;
        }

        extractedData = []; // Reset data
        outputTable.innerHTML = `
    <tr>
        <th>Name</th>
        <th>Bachelor’s University</th>
        <th>Bachelor’s CGPA</th>
        <th>Bachelor’s Year</th>
        <th>Master’s University</th>
        <th>Master’s CGPA</th>
        <th>GRE Score</th>
        <th>IELTS Score</th>
        <th>TOEFL Score</th>
        <th>Awards</th>
        <th>Research Interests</th>
        <th>Latest Papers</th>
        <th>PDF Link</th>
    </tr>
  `;

        const batchSize = 15;
        const batches = Math.ceil(files.length / batchSize);

        for (let batchIndex = 0; batchIndex < batches; batchIndex++) {
          const batchFiles = files.slice(
            batchIndex * batchSize,
            (batchIndex + 1) * batchSize
          );

          console.log(`Processing batch ${batchIndex + 1} of ${batches}`);

          await Promise.all(
            batchFiles.map(async (file) => {
              try {
                const text = await extractTextFromPdf(file);
                const features = await extractFeaturesWithChatGPT(text);

                if (!features || Object.keys(features).length === 0) {
                  console.error(`No features extracted for ${file.name}`);
                  return;
                }

                features.name = file.name || "Unknown Name";
                features.link = URL.createObjectURL(file);
                features.bachelor_uni =
                  features.bachelor_uni || "Not Available";
                features.bachelor_cgpa =
                  features.bachelor_cgpa || "Not Available";
                features.bachelor_year =
                  features.bachelor_year || "Not Available";
                features.master_uni = features.master_uni || "Not Available";
                features.master_cgpa = features.master_cgpa || "Not Available";
                features.gre = features.gre || "Not Available";
                features.ielts = features.ielts || "Not Available";
                features.toefl = features.toefl || "Not Available";
                features.awards = Array.isArray(features.awards)
                  ? features.awards.join(", ")
                  : "Not Available";
                features.research_interests =
                  features.research_interests || "Not Available";
                features.latest_papers =
                  features.latest_papers || "Not Available";

                extractedData.push(features);

                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${features.name}</td>
            <td>${features.bachelor_uni}</td>
            <td>${features.bachelor_cgpa}</td>
            <td>${features.bachelor_year}</td>
            <td>${features.master_uni}</td>
            <td>${features.master_cgpa}</td>
            <td>${features.gre}</td>
            <td>${features.ielts}</td>
            <td>${features.toefl}</td>
            <td>${features.awards}</td>
            <td>${features.research_interests}</td>
            <td>${features.latest_papers}</td>
            <td><a href="${features.link}" target="_blank">Open PDF</a></td>
          `;
                outputTable.appendChild(row);
              } catch (error) {
                console.error(`Error processing ${file.name}:`, error);
              }
            })
          );

          console.log(`Batch ${batchIndex + 1} completed.`);
        }
      }

      async function extractTextFromPdf(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = "";

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map((item) => item.str).join(" ") + "\n";
        }

        return text;
      }

      async function extractFeaturesWithChatGPT(text) {
        const RETRY_LIMIT = 3;
        let attempts = 0;

        while (attempts < RETRY_LIMIT) {
          try {
            const response = await fetch(
              "https://hgaj64gax1.execute-api.us-east-1.amazonaws.com/dev/processResumes",
              {
                method: "POST",
                mode: "cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text }),
              }
            );

            if (response.ok) {
              const parsedResponse = await response.json();
              const content = parsedResponse.choices?.[0]?.message?.content;

              if (!content) {
                throw new Error("Empty response from API");
              }

              return JSON.parse(content);
            } else if (response.status === 503) {
              console.warn("Service Unavailable (503). Retrying...");
            } else {
              console.error(
                `API returned status ${
                  response.status
                }: ${await response.text()}`
              );
              throw new Error(`API Error: ${response.status}`);
            }
          } catch (err) {
            console.error("Error in API call:", err);
          }

          attempts += 1;
          console.log(`Retrying... Attempt ${attempts}`);
          await new Promise((resolve) => setTimeout(resolve, 2000));
        }

        throw new Error(
          "Failed to process API response after multiple attempts."
        );
      }

      function downloadJson() {
        if (extractedData.length === 0) {
          alert("No data to download. Process the resumes first.");
          return;
        }

        const dataStr =
          "data:text/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify(extractedData, null, 2));
        const downloadAnchorNode = document.createElement("a");
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "resumes.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      }

      function downloadCsv() {
        if (extractedData.length === 0) {
          alert("No data to download. Process the resumes first.");
          return;
        }

        const worksheet = XLSX.utils.json_to_sheet(
          extractedData.map((feature) => ({
            Name: feature.name,
            "Bachelor’s University": feature.bachelor_university,
            "Bachelor’s CGPA": feature.bachelor_cgpa,
            "Bachelor’s Year": feature.bachelor_year,
            "Master’s University": feature.master_university,
            "Master’s CGPA": feature.master_cgpa,
            "GRE Score": feature.gre,
            "IELTS Score": feature.ielts,
            "TOEFL Score": feature.toefl,
            Awards: feature.awards,
            "Research Interests": feature.research_interests,
            "Latest Papers": feature.latest_papers,
            "PDF Link": feature.link,
          }))
        );
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Resumes");
        XLSX.writeFile(workbook, "resumes.xlsx");
      }

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdn.jsdelivr.net/npm/pdfjs-dist/build/pdf.worker.min.js";
    </script>
  </body>
</html>
